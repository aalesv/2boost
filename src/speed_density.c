// This is an independent project of an individual developer. Dear PVS-Studio, please check it.

// PVS-Studio Static Code Analyzer for C, C++, C#, and Java: http://www.viva64.com

/*This file is part of 2Boost
*
*2Boost is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
*
*This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.
*/

#include "speed_density.h"
#if defined(SPEED_DENSITY)

//Speed Density constant 0.0038728181
static const float speedDensityConstant = 0.0038728181f;

//This function replaces original calc MAF table function
float 
massAirflow_hooked(float mafVoltage, const table_2d_noconv_t *tablePointerMAF)
{
    float   iatKelvin;                  //Intake air temperature, Kelvin

    //Set log varibles
    //Mass air flow from MAF sensor
    RAM_VARIABLES->airFlowFromMaf = calc_2d_float_to_float (mafVoltage, 
                                                            tablePointerMAF);
    //VE table value
    RAM_VARIABLES->volumetricEfficiency 
                                = calc_3d_uint_to_float (*P_MANIFOLD_PRESSURE
                                                       , *P_ENGINE_SPEED
                                                       , &tblVe);
    //VE tip-in value
    RAM_VARIABLES->volumetricEfficiencyTipIn 
                            = calc_3d_uint_to_float (*P_THROTTLE_ANGLE_CHANGE
                                                   , *P_ENGINE_SPEED
                                                   , &tblVeTipIn);
    //MAF/SD blendig mode
    RAM_VARIABLES->mafSdBlendMode = CFG_MAF_SD_BLENDING;
    //If blending enabled
    if ((RAM_VARIABLES->mafSdBlendMode) == MAF_SD_BLENDING_ON)
    {
        //Calc blend coefficient
       RAM_VARIABLES->mafSdBlendValue 
                                = calc_3d_uint_to_float (*P_MANIFOLD_PRESSURE
                                                       , *P_ENGINE_SPEED
                                                       , &tblMafSdBlend);
    }
    else
    {
        //No blending, only Speed Density
        RAM_VARIABLES->mafSdBlendValue = 1;
    }
    
    //Convert temperature to Kelvin
    iatKelvin = *P_IAT + 273.15f;

    //Calculate SD mass airflow
    RAM_VARIABLES->airFlowFromSdNotBlended
                    = CFG_ENGINE_DISPLACEMENT
                    * (*P_ENGINE_SPEED)
                    * (*P_MANIFOLD_PRESSURE)
                    * RAM_VARIABLES->volumetricEfficiency
                    * RAM_VARIABLES->volumetricEfficiencyTipIn
                    * speedDensityConstant / iatKelvin;

    //Do blending
    //Blending formula
    //MAF*(1-Blend_Value) + SD*Blend_Value
    RAM_VARIABLES->airFlowFromSD
      = (RAM_VARIABLES->airFlowFromMaf * (1 - RAM_VARIABLES->mafSdBlendValue))
      + (RAM_VARIABLES->airFlowFromSdNotBlended * RAM_VARIABLES->mafSdBlendValue);
    
    return RAM_VARIABLES->airFlowFromSD;
}

//Tables defined and populated manually

//VE table X axis
static const float tblVe_x_axis [VE_X_COUNT] = 
 {0.0, 112.5, 165.0, 240.0, 322.5, 405.0, 472.5, 570.0, 650.0, 685.0, 720.0, 750.0, 780.0, 810.0, 850.0, 905.0, 950.0, 1040.0, 1155.0, 1250.0, 1345.0, 1443.0, 1545.0, 1640.0, 1700.0, 1750.0, 1773.0, 1860.0, 1935.0, 2013.0, 2060.0, 2160.0};
//VE table Y axis
static const float tblVe_y_axis [VE_Y_COUNT] = 
 {0.0, 400.0, 800.0, 900.0, 1000.0, 1100.0, 1200.0, 1300.0, 1400.0, 1600.0, 1800.0, 2000.0, 2400.0, 2800.0, 3200.0, 3400.0, 3600.0, 3800.0, 4000.0, 4200.0, 4400.0, 4600.0, 4800.0, 5200.0, 5600.0, 6000.0, 6400.0, 6800.0, 7200.0, 7600.0};
//VE table data
static const UINT_0x8000000 tblVe_data [VE_X_COUNT * VE_Y_COUNT] = 
{
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 10813, 13355, 13873, 14202, 14055, 14292, 14189, 14159, 13600, 13041, 12869, 12829, 12788, 12735, 12710, 12801, 12984, 12590, 12911, 13231, 13563, 13907, 14228, 14430, 14599, 14676, 14969, 15222, 15485, 15525, 15525,
0, 11266, 13285, 13950, 14613, 14879, 15270, 15218, 14251, 14012, 13772, 13705, 13698, 13690, 13680, 13665, 13654, 13953, 14666, 14986, 15187, 15278, 15374, 15461, 15518, 15564, 15585, 15667, 15901, 16153, 16192, 16192,
0, 11235, 13260, 13928, 14593, 14924, 15325, 15433, 14727, 14438, 14148, 14068, 14059, 14051, 14061, 14071, 14069, 14369, 14994, 15307, 15530, 15672, 15821, 15944, 16022, 16086, 16116, 16229, 16450, 16686, 16722, 16722,
0, 11203, 13236, 13906, 14573, 14970, 15380, 15649, 15202, 14864, 14525, 14431, 14421, 14411, 14443, 14477, 14483, 14784, 15323, 15628, 15873, 16067, 16268, 16426, 16526, 16608, 16647, 16792, 16999, 17219, 17252, 17252,
0, 11172, 13211, 13884, 14553, 15015, 15435, 15864, 15678, 15290, 14901, 14794, 14783, 14772, 14824, 14883, 14898, 15199, 15652, 15949, 16215, 16462, 16716, 16908, 17029, 17131, 17177, 17354, 17548, 17751, 17783, 17783,
0, 11141, 13187, 13862, 14532, 15060, 15490, 16080, 16154, 15716, 15278, 15157, 15144, 15132, 15206, 15288, 15313, 15614, 15981, 16270, 16558, 16856, 17163, 17391, 17533, 17653, 17708, 17917, 18097, 18284, 18313, 18313,
0, 11155, 13181, 13884, 14566, 15075, 15525, 16125, 16314, 16021, 15728, 15646, 15637, 15628, 15720, 15828, 15870, 16144, 16423, 16678, 16932, 17255, 17504, 17698, 17820, 17922, 17969, 18118, 18241, 18368, 18388, 18388,
0, 11168, 13176, 13906, 14600, 15090, 15560, 16170, 16474, 16326, 16178, 16136, 16130, 16124, 16235, 16368, 16428, 16675, 16865, 17086, 17305, 17654, 17845, 18006, 18106, 18191, 18230, 18320, 18386, 18452, 18463, 18463,
0, 11196, 13165, 13950, 14667, 15119, 15631, 16260, 16794, 16937, 17079, 17116, 17116, 17116, 17265, 17447, 17543, 17735, 17750, 17901, 18052, 18452, 18526, 18621, 18679, 18729, 18752, 18723, 18675, 18621, 18612, 18612,
0, 11223, 13046, 13925, 14766, 15215, 15821, 16448, 16919, 17088, 17257, 17330, 17373, 17416, 17548, 17719, 17831, 18056, 18031, 18200, 18377, 18722, 18756, 18796, 18862, 18914, 18937, 18914, 18869, 18821, 18813, 18813,
0, 11250, 12928, 13901, 14866, 15311, 16012, 16635, 17044, 17239, 17435, 17545, 17631, 17717, 17832, 17990, 18119, 18376, 18313, 18500, 18702, 18992, 18985, 18971, 19046, 19099, 19123, 19105, 19063, 19021, 19014, 19014,
0, 11512, 13241, 14295, 15073, 15532, 16288, 17142, 17596, 17597, 17598, 17666, 17762, 17859, 18096, 18368, 18462, 18566, 18693, 18891, 19115, 19370, 19264, 19324, 19380, 19301, 19263, 19210, 19168, 19124, 19117, 19117,
0, 11654, 13123, 14398, 15454, 16325, 16822, 17313, 17623, 17665, 17708, 17801, 17918, 18036, 18190, 18365, 18418, 18635, 18696, 19041, 19422, 19809, 19874, 19787, 19719, 19502, 19401, 19317, 19273, 19229, 19222, 19222,
0, 11696, 13265, 14437, 15772, 16681, 17191, 17697, 17920, 17970, 18020, 18053, 18081, 18110, 18136, 18209, 18361, 18613, 18919, 19361, 19653, 20006, 20081, 20000, 20040, 19746, 19608, 19507, 19391, 19187, 19154, 19154,
0, 11805, 13346, 14718, 16114, 17074, 17502, 17889, 18069, 18096, 18123, 18169, 18224, 18280, 18317, 18406, 18570, 18788, 19144, 19546, 19863, 20227, 20251, 20073, 19998, 19774, 19670, 19565, 19385, 19068, 19016, 19016,
0, 11914, 13426, 14999, 16456, 17468, 17813, 18082, 18217, 18221, 18225, 18284, 18367, 18451, 18499, 18603, 18778, 18962, 19368, 19731, 20073, 20448, 20422, 20146, 19956, 19803, 19732, 19622, 19379, 18948, 18879, 18879,
0, 12135, 13619, 15237, 16630, 17681, 18023, 18291, 18548, 18574, 18599, 18621, 18642, 18664, 18712, 18798, 18912, 19251, 19701, 19993, 20207, 20430, 20386, 20076, 19789, 19603, 19518, 19304, 19022, 18617, 18552, 18552,
0, 12356, 13812, 15474, 16804, 17894, 18232, 18500, 18879, 18926, 18974, 18957, 18917, 18877, 18925, 18992, 19046, 19539, 20033, 20256, 20340, 20413, 20351, 20006, 19621, 19403, 19304, 18986, 18666, 18285, 18226, 18226,
0, 12644, 14005, 15712, 17058, 18164, 18515, 18800, 19178, 19200, 19222, 19167, 19081, 18996, 19015, 19061, 19143, 19640, 20254, 20564, 20629, 20560, 20417, 20055, 19705, 19434, 19309, 18977, 18667, 18306, 18250, 18250,
0, 12932, 14197, 15949, 17312, 18435, 18798, 19101, 19477, 19473, 19470, 19377, 19246, 19115, 19105, 19129, 19240, 19741, 20475, 20872, 20919, 20708, 20482, 20103, 19790, 19464, 19313, 18968, 18668, 18327, 18274, 18274,
0, 13058, 14309, 16118, 17560, 18545, 18907, 19210, 19586, 19583, 19579, 19486, 19355, 19224, 19214, 19257, 19429, 19868, 20475, 20919, 21028, 20817, 20583, 20103, 19790, 19464, 19313, 18968, 18668, 18327, 18274, 18274,
0, 13184, 14421, 16287, 17807, 18654, 19016, 19319, 19696, 19692, 19688, 19595, 19464, 19333, 19323, 19386, 19617, 19995, 20475, 20966, 21137, 20926, 20684, 20103, 19790, 19464, 19313, 18968, 18668, 18327, 18274, 18274,
0, 13666, 14957, 16636, 18105, 18783, 19143, 19439, 19643, 19645, 19647, 19588, 19503, 19418, 19554, 19741, 19894, 20081, 20531, 20845, 20971, 20948, 20602, 19562, 19160, 18826, 18672, 18328, 18245, 17965, 17918, 17918,
0, 14132, 15531, 17187, 18527, 19318, 19593, 19769, 20021, 19790, 19559, 19474, 19439, 19403, 19528, 19701, 19843, 20127, 20614, 20773, 20843, 20844, 20031, 18863, 18508, 18082, 17885, 17501, 17359, 17220, 17199, 17199,
0, 14837, 16114, 17720, 18949, 19635, 19824, 19871, 19869, 19683, 19497, 19393, 19314, 19235, 19350, 19509, 19639, 19990, 20516, 20631, 20676, 20363, 19537, 18262, 17585, 17400, 17318, 17009, 16740, 16462, 16419, 16419,
0, 15412, 16530, 17999, 19277, 19982, 20186, 20254, 20264, 19999, 19733, 19563, 19416, 19270, 19312, 19370, 19419, 19606, 19980, 20007, 20011, 19618, 18699, 17710, 17211, 17033, 16953, 16650, 16389, 16118, 16076, 16076,
0, 15779, 16878, 18352, 19520, 20185, 20358, 20381, 20358, 20133, 19909, 19715, 19522, 19329, 19276, 19203, 19142, 19105, 19088, 19006, 19021, 18768, 18178, 17271, 16825, 16675, 16607, 16353, 16133, 15906, 15871, 15871,
0, 15927, 17029, 18637, 19622, 20321, 20524, 20592, 20606, 20400, 20194, 19962, 19705, 19449, 19339, 19188, 19064, 18970, 18851, 18860, 18878, 18712, 18258, 17347, 16900, 16710, 16625, 16299, 16020, 15730, 15685, 15685,
0, 16076, 17096, 18686, 19770, 20296, 20535, 20655, 20712, 20537, 20361, 20154, 19923, 19691, 19489, 19209, 18980, 18866, 18737, 18779, 18848, 18680, 18339, 17424, 16972, 16744, 16641, 16247, 15907, 15555, 15501, 15501,
};
//VE table structure, uint16 to float
const table_3d_uint_t tblVe =
{
    .x_len = VE_X_COUNT,
    .y_len = VE_Y_COUNT,
    .x_axis_ptr = & tblVe_x_axis,
    .y_axis_ptr = & tblVe_y_axis,
    .data_ptr = & tblVe_data,
    .data_type = 0x8000000,
    .multiplier = 0.0000457763672f,
    .offset = 0
};

//VE Tip-in table X axis
static const float tblVeTipIn_x_axis [VE_TIP_IN_X_COUNT] =
 {-2.0, 0.0, 0.5, 0.8, 1.0, 1.5, 2.0, 2.2, 2.5, 3.0, 3.25, 3.5, 3.75, 4.0, 4.5, 5.0};
//VE Tip-in table Y axis
static const float tblVeTipIn_y_axis [VE_TIP_IN_Y_COUNT] =
 {0.0, 400.0, 600.0, 800.0, 1000.0, 1200.0, 1400.0, 1600.0, 1800.0, 2000.0, 2200.0, 2400.0, 2600.0, 3000.0, 4500.0, 7500.0};
//VE Tip-in table data
static const UINT_0x8000000 tblVeTipIn_data [VE_TIP_IN_X_COUNT * VE_TIP_IN_Y_COUNT] = 
{
21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845,
21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845,
21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845,
21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845, 21845,
21845, 21845, 21845, 24107, 25992, 26608, 27224, 27840, 28456, 29072, 29688, 30304, 30920, 31536, 32152, 32768,
21845, 21845, 21845, 27462, 30072, 32986, 34685, 35364, 36383, 38083, 38933, 39783, 40632, 41141, 42159, 43691,
21845, 21845, 21845, 27462, 30072, 32986, 34685, 35364, 36383, 38083, 38933, 39783, 40632, 41141, 42159, 43691,
21845, 21845, 21845, 25151, 27524, 30147, 31894, 32593, 33642, 35389, 36263, 37137, 38011, 38702, 40084, 42159,
21845, 21845, 21845, 25196, 26887, 27798, 28708, 29072, 29855, 31237, 31929, 32622, 33314, 33841, 34896, 36480,
21845, 21845, 21845, 24047, 25641, 26459, 27157, 27436, 27949, 28836, 29309, 29782, 30256, 30638, 31403, 32550,
21845, 21845, 21845, 23587, 25141, 25924, 26537, 26782, 27206, 27932, 28313, 28694, 29075, 29392, 30026, 30968,
21845, 21845, 21845, 23126, 24642, 25390, 25917, 26128, 26463, 27029, 27317, 27606, 27895, 28146, 28648, 29386,
21845, 21845, 21845, 22857, 24346, 25063, 25539, 25729, 26015, 26491, 26729, 26967, 27205, 27420, 27849, 28473,
21845, 21845, 21845, 22701, 24161, 24824, 25265, 25441, 25706, 26147, 26367, 26588, 26808, 27007, 27404, 27982,
21845, 21845, 21845, 22117, 23466, 23931, 24239, 24363, 24548, 24856, 25011, 25165, 25319, 25458, 25736, 26141,
21845, 21845, 21845, 22050, 22077, 22143, 22187, 22205, 22231, 22275, 22298, 22320, 22342, 22361, 22401, 22459
};
//VE Tip-in table structure, uint16 to float
const table_3d_uint_t tblVeTipIn =
{
    .x_len = VE_TIP_IN_X_COUNT,
    .y_len = VE_TIP_IN_Y_COUNT,
    .x_axis_ptr = & tblVeTipIn_x_axis,
    .y_axis_ptr = & tblVeTipIn_y_axis,
    .data_ptr = & tblVeTipIn_data,
    .data_type = 0x8000000,
    .multiplier = 0.0000457763672f,
    .offset = 0
};

//MAF/SD blending table X axis
static const float tblMafSdBlend_x_axis [MAF_SD_BLEND_X_COUNT] =
 {160.0, 350.0, 420.0, 536.0, 650.0, 750.0, 780.0, 850.0, 950.0, 1155.0, 1345.0, 1545.0, 1700.0, 1773.0, 1935.0, 2060.0};
//MAF/SD blending table Y axis
static const float tblMafSdBlend_y_axis [MAF_SD_BLEND_Y_COUNT] =
 {700.0, 900.0, 1000.0, 1200.0, 1400.0, 1800.0, 2400.0, 3200.0, 3600.0, 4000.0, 4400.0, 4800.0, 5600.0, 6400.0, 7200.0, 7600.0};
//MAF/SD blending table data
static const  UINT_0x8000000 tblMafSdBlend_data [MAF_SD_BLEND_X_COUNT * MAF_SD_BLEND_Y_COUNT] =
{
 0,    0,    0,    0,    0,    16383,32767,49151,65535,65535,65535,65535,65535,65535,65535,65535,
 0,    0,    0,    0,    16383,32767,49151,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 0,    0,    0,    16383,32767,49151,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 0,    0,    0,    32767,49151,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 0,    16383,16383,49151,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 16383,32767,49151,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 32767,49151,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 49151,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,
 65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535
 };
//MAF/SD blending table structure , uint16 to float
//MAF = 0 , SD = 1
const table_3d_uint_t tblMafSdBlend =
{
    .x_len = MAF_SD_BLEND_X_COUNT,
    .y_len = MAF_SD_BLEND_Y_COUNT,
    .x_axis_ptr = & tblMafSdBlend_x_axis,
    .y_axis_ptr = & tblMafSdBlend_y_axis,
    .data_ptr = & tblMafSdBlend_data,
    .data_type = 0x8000000,
    .multiplier = 0.000015259f,
    .offset = 0
};

#endif